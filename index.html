<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BGU Mobility Survey - Interactive POI Map</title>
    <link rel="icon" href="assets/media/favicon.ico" sizes="any" />
    <link
      rel="shortcut icon"
      href="assets/media/favicon.ico"
      type="image/x-icon"
    />

    <!-- MapLibre GL JS -->
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link
      href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css"
      rel="stylesheet"
    />

    <!-- deck.gl -->
    <script src="https://unpkg.com/deck.gl@^9.0.0/dist.min.js"></script>

    <!-- Inter Font -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Font Awesome for icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
        background: #f5f5f5;
        color: #333333;
        overflow: hidden;
        height: 100vh;
      }

      .info-btn {
        height: 30px;
        width: 30px;
        padding: 0;
        background: linear-gradient(
          135deg,
          rgba(100, 255, 218, 0.2),
          rgba(0, 188, 212, 0.1)
        );
        backdrop-filter: blur(12px);
        border: 1px solid rgba(100, 255, 218, 0.35);
        border-radius: 50%;
        color: #64ffda;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0;
        box-shadow: 0 4px 12px rgba(100, 255, 218, 0.2);
        line-height: 1;
        white-space: nowrap;
      }

      .info-btn:hover {
        background: linear-gradient(
          135deg,
          rgba(100, 255, 218, 0.3),
          rgba(0, 188, 212, 0.2)
        );
        border-color: rgba(100, 255, 218, 0.5);
        color: #ffffff;
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(100, 255, 218, 0.3);
      }

      #map {
        width: 100vw;
        height: 100vh;
        position: relative;
        top: 0;
      }

      /* Smooth transitions for map layers */
      .maplibregl-map .maplibregl-canvas {
        transition: filter 0.2s ease;
      }

      /* Enhanced rendering for smooth overlapping lines */
      .maplibregl-map {
        image-rendering: auto;
        image-rendering: -webkit-optimize-contrast;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      /* Force hardware acceleration for smoother rendering */
      .maplibregl-canvas {
        will-change: transform;
        transform: translateZ(0);
      }

      /* Glass Panel Base - Dark Mode */
      .ui-panel {
        position: absolute;
        background: linear-gradient(
          135deg,
          rgba(15, 18, 20, 0.85),
          rgba(20, 22, 24, 0.75)
        );
        backdrop-filter: blur(18px) saturate(140%);
        -webkit-backdrop-filter: blur(18px) saturate(140%);
        border: 1px solid rgba(255, 255, 255, 0.16);
        border-radius: 18px;
        padding: 20px;
        z-index: 1000;
        transition: background 0.3s ease, transform 0.3s ease,
          border-color 0.3s ease, box-shadow 0.3s ease;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.45),
          inset 0 1px 0 rgba(255, 255, 255, 0.06);
      }

      .ui-panel:hover {
        background: linear-gradient(
          135deg,
          rgba(15, 18, 20, 0.9),
          rgba(20, 22, 24, 0.8)
        );
        transform: translateY(-2px);
        border-color: rgba(255, 255, 255, 0.22);
        box-shadow: 0 14px 48px rgba(0, 0, 0, 0.5),
          inset 0 1px 0 rgba(255, 255, 255, 0.08);
      }

      /* Title Section */
      .title-section {
        margin-bottom: 20px;
      }

      .project-title {
        background: linear-gradient(135deg, #64ffda, #00bcd4);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        font-size: 28px;
        text-align: center;
        font-weight: 700;
        letter-spacing: 0.5px;
        text-shadow: 0 2px 4px rgba(100, 255, 218, 0.2);
        position: relative;
        margin: 0;
      }

      .project-title::after {
        content: "";
        position: absolute;
        bottom: -4px;
        left: 0;
        width: 100%;
        height: 2px;
        background: linear-gradient(90deg, transparent, #64ffda, transparent);
        border-radius: 1px;
      }

      /* Logo Section in Control Panel */
      .logo-section {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 10px;
        justify-content: center;
        flex-wrap: wrap;
      }

      .logo-section .logo-item {
        display: flex;
        align-items: center;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .logo-section .logo-item:hover {
        transform: scale(1.05);
      }

      .logo-section .logo-item img {
        height: 40px;
        width: auto;
        object-fit: contain;
      }

      .logo-section .logo-item.nur img {
        height: 35px;
        filter: brightness(0) invert(1); /* Make NUR logo white */
      }

      .logo-section .logo-item.zencity img {
        height: 45px;
        /* Preserve ZenCity logo colors - no filter */
      }

      /* Combined Info & Controls Panel */
      .info-controls-panel {
        top: 5px;
        left: 5px;
        max-width: 360px;
      }

      .panel-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 16px;
        color: #ffffff;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .info-section {
        margin-bottom: 12px;
      }

      .info-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-bottom: 14px;
      }

      .info-item {
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 12px;
        padding: 12px;
        text-align: center;
      }

      .info-number {
        font-size: 24px;
        font-weight: 700;
        color: #64ffda;
        display: block;
        margin-bottom: 4px;
      }

      .info-label {
        font-size: 13px;
        color: rgba(255, 255, 255, 0.7);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 500;
      }

      /* Gradient Legend */
      .legend-gradient {
        margin-bottom: 16px;
      }

      .gradient-bar {
        height: 20px;
        background: linear-gradient(
          to right,
          #004d00,
          #006400,
          #228b22,
          #32cd32,
          #90ee90
        );
        border-radius: 10px;
        margin-bottom: 8px;
        border: 1px solid rgba(255, 255, 255, 0.3);
      }

      .gradient-labels {
        display: flex;
        justify-content: space-between;
        font-size: 12px;
        color: rgba(255, 255, 255, 0.9);
      }

      /* Legend Section (moved into modal) */
      .legend-section {
        margin-bottom: 16px;
        padding-bottom: 12px;
        position: relative;
      }

      .legend-section::after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 2px;
        background: linear-gradient(90deg, transparent, #64ffda, transparent);
        border-radius: 1px;
      }

      .legend-items {
        display: flex;
        align-items: center;
        flex-direction: column;
        gap: 6px;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        color: rgba(255, 255, 255, 0.95);
        font-weight: 500;
      }

      .legend-color {
        width: 16px;
        height: 8px;
        border-radius: 2px;
        border: 1px solid rgba(255, 255, 255, 0.3);
      }

      .legend-label {
        flex: 1;
      }

      /* Classic boxed legend style inside info modal */
      .legend-classic .legend-item {
        width: 100%;
        background: #ffffff;
        border: 1px solid #dcdcdc;
        border-radius: 8px;
        padding: 8px 10px;
        color: #222;
      }
      .legend-classic .legend-color {
        border: 1px solid #bdbdbd;
      }

      /* Map Controls - Improved Vertical Stack */
      .map-controls {
        position: absolute;
        top: 20px;
        right: 20px;
        z-index: 1001;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .map-control-btn {
        width: 40px;
        height: 40px;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 12px;
        color: rgba(255, 255, 255, 0.95);
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .map-control-btn:hover {
        background: rgba(0, 0, 0, 0.9);
        transform: translateY(-1px);
      }

      /* MapLibre Controls Styling - In Same Container */
      .maplibregl-ctrl-top-right {
        position: static !important;
        margin: 0 !important;
      }

      .maplibregl-ctrl-bottom-right {
        bottom: 20px !important;
        right: 20px !important;
      }

      .maplibregl-ctrl-group {
        background: rgba(0, 0, 0, 0.8) !important;
        backdrop-filter: blur(20px) !important;
        -webkit-backdrop-filter: blur(20px) !important;
        border: 1px solid rgba(255, 255, 255, 0.3) !important;
        border-radius: 12px !important;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3) !important;
        width: 40px !important;
        margin-bottom: 8px !important;
      }

      /* Remove margin when MapLibre controls are inside our container */
      .map-controls .maplibregl-ctrl-group {
        margin-bottom: 0 !important;
        margin-top: 0 !important;
      }

      .maplibregl-ctrl-group button {
        background: transparent !important;
        border: none !important;
        color: rgba(255, 255, 255, 0.95) !important;
        transition: all 0.3s ease !important;
        width: 40px !important;
        height: 40px !important;
      }

      .maplibregl-ctrl-group button:hover {
        background: rgba(255, 255, 255, 0.1) !important;
        color: #ffffff !important;
        transform: translateY(-1px) !important;
      }

      /* Enhance compass visibility on dark background */
      .maplibregl-ctrl-bottom-right .maplibregl-ctrl-group.compass-group {
        background: rgba(0, 0, 0, 0.9) !important;
        border: 1px solid rgba(100, 255, 218, 0.35) !important;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.45),
          0 0 0 1px rgba(100, 255, 218, 0.1) inset !important;
      }
      .maplibregl-ctrl-bottom-right
        .maplibregl-ctrl-group.compass-group
        .maplibregl-ctrl-icon {
        filter: invert(1) brightness(1.4)
          drop-shadow(0 0 4px rgba(100, 255, 218, 0.45)) !important;
      }
      .maplibregl-ctrl-bottom-right
        .maplibregl-ctrl-group.compass-group
        button:hover {
        background: rgba(100, 255, 218, 0.12) !important;
      }

      /* Simple filter approach for MapLibre control icons - inverts them to white */
      .maplibregl-ctrl-zoom-in .maplibregl-ctrl-icon,
      .maplibregl-ctrl-zoom-out .maplibregl-ctrl-icon,
      .maplibregl-ctrl-compass .maplibregl-ctrl-icon {
        filter: invert(1) brightness(1.2) !important;
      }

      .maplibregl-ctrl-group button:first-child {
        border-top-left-radius: 12px !important;
        border-top-right-radius: 12px !important;
      }

      .maplibregl-ctrl-group button:last-child {
        border-bottom-left-radius: 12px !important;
        border-bottom-right-radius: 12px !important;
      }

      .maplibregl-ctrl-scale {
        background: rgba(0, 0, 0, 0.8) !important;
        backdrop-filter: blur(20px) !important;
        -webkit-backdrop-filter: blur(20px) !important;
        border: 1px solid rgba(255, 255, 255, 0.3) !important;
        border-radius: 8px !important;
        color: rgba(255, 255, 255, 0.95) !important;
        padding: 4px 8px !important;
        font-size: 13px !important;
        font-family: "Inter", sans-serif !important;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2) !important;
      }

      /* Loading Overlay */
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        transition: opacity 0.5s ease;
      }

      .loading-content {
        text-align: center;
        color: #ffffff;
      }

      .loading-spinner {
        width: 50px;
        height: 50px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-top: 3px solid #64ffda;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Analysis Links */
      .analysis-links {
        margin-top: 16px;
      }

      .analysis-links h3 {
        font-size: 22px;
        font-weight: 600;
        margin-bottom: 12px;
        color: rgba(255, 255, 255, 0.95);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .analysis-btn {
        display: block;
        width: 100%;
        padding: 8px 12px;
        background: rgba(255, 255, 255, 0.15);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 12px;
        color: rgba(255, 255, 255, 0.95);
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: left;
        margin-bottom: 6px;
        text-decoration: none;
      }

      .analysis-btn:hover {
        background: rgba(255, 255, 255, 0.25);
        transform: translateX(2px);
      }

      /* Narrative style for Analysis section */
      .analysis-narrative {
        font-size: 15px;
        color: rgba(255, 255, 255, 0.95);
        line-height: 1.7;
      }

      .analysis-narrative a {
        color: #64ffda;
        font-weight: 600;
        text-decoration: none;
        border-bottom: 1px dashed rgba(100, 255, 218, 0.6);
        transition: color 0.2s ease, border-color 0.2s ease;
      }

      .analysis-narrative a:hover {
        color: #ffffff;
        border-bottom-color: #ffffff;
      }

      /* Add spacing between narrative bullet points */
      .analysis-narrative li {
        margin-bottom: 10px;
      }
      .analysis-narrative li:last-child {
        margin-bottom: 0;
      }

      /* Info Modal */
      .info-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        backdrop-filter: blur(5px);
      }

      .info-modal.show {
        display: flex;
      }

      .info-modal-content {
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.95),
          rgba(240, 250, 255, 0.9)
        );
        backdrop-filter: blur(20px);
        border: 2px solid rgba(100, 255, 218, 0.3);
        border-radius: 20px;
        padding: 28px;
        max-width: 520px;
        text-align: left;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        position: relative;
        max-height: 80vh;
        overflow: auto;
      }

      .info-modal-close {
        position: absolute;
        top: 15px;
        right: 20px;
        width: 30px;
        height: 30px;
        background: rgba(100, 255, 218, 0.2);
        border: none;
        border-radius: 50%;
        color: #333;
        font-size: 18px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
      }

      .info-modal-close:hover {
        background: rgba(100, 255, 218, 0.3);
        transform: scale(1.1);
      }

      .info-modal h2 {
        color: #333;
        margin-bottom: 20px;
        font-size: 24px;
        background: linear-gradient(135deg, #64ffda, #00bcd4);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .info-modal p {
        color: #666;
        font-size: 16px;
        line-height: 1.6;
      }

      /* Popup Styling */
      .poi-popup,
      .gate-popup,
      .route-popup {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        padding: 16px;
        color: #333;
        font-family: "Inter", sans-serif;
        max-width: 250px;
      }

      /* Chart Modal */
      .chart-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        backdrop-filter: blur(5px);
      }

      .chart-modal.show {
        display: flex;
      }

      .chart-modal-content {
        background: #0f1214;
        border: 1px solid rgba(255, 255, 255, 0.16);
        border-radius: 16px;
        width: min(92vw, 1100px);
        height: min(86vh, 800px);
        position: relative;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        overflow: hidden;
      }

      .chart-modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 14px;
        background: rgba(255, 255, 255, 0.06);
        color: #fff;
        font-weight: 600;
        font-size: 14px;
      }

      .chart-modal-close {
        background: rgba(100, 255, 218, 0.2);
        border: none;
        color: #fff;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        cursor: pointer;
      }

      .chart-frame {
        width: 100%;
        height: calc(100% - 50px);
        border: 0;
        background: #fff;
      }

      /* Info modal comment box */
      .comment-box {
        background: #ffffff;
        border: 1px solid #dcdcdc;
        border-radius: 10px;
        padding: 12px;
        margin-top: 10px;
      }
      .comment-box .comment-title {
        font-weight: 600;
        font-size: 14px;
        color: #222;
        margin-bottom: 6px;
      }
      .comment-email {
        width: 100%;
        border: 1px solid #cfcfcf;
        border-radius: 8px;
        padding: 8px;
        font-family: "Inter", sans-serif;
        font-size: 13px;
        color: #333;
        background: #fafafa;
        margin-bottom: 8px;
      }
      .comment-textarea {
        width: 100%;
        min-height: 80px;
        border: 1px solid #cfcfcf;
        border-radius: 8px;
        padding: 8px;
        font-family: "Inter", sans-serif;
        font-size: 13px;
        color: #333;
        resize: vertical;
        background: #fafafa;
      }
      .comment-hint {
        font-size: 12px;
        color: #666;
        margin-top: 6px;
      }
      .comment-send-btn {
        margin-top: 10px;
        background: linear-gradient(
          135deg,
          rgba(100, 255, 218, 0.25),
          rgba(0, 188, 212, 0.15)
        );
        border: 1px solid rgba(100, 255, 218, 0.4);
        color: #0b3d3a;
        font-weight: 600;
        border-radius: 10px;
        padding: 8px 12px;
        cursor: pointer;
        transition: transform 0.15s ease, background 0.2s ease;
      }
      .comment-send-btn:hover {
        background: linear-gradient(
          135deg,
          rgba(100, 255, 218, 0.35),
          rgba(0, 188, 212, 0.25)
        );
        transform: translateY(-1px);
      }

      .poi-popup h4,
      .gate-popup h4,
      .route-popup h4 {
        color: #2c3e50;
        margin: 0 0 8px 0;
        font-size: 14px;
        font-weight: 600;
      }

      .poi-comment {
        color: #666;
        font-style: italic;
        margin: 0;
        font-size: 12px;
      }

      .mode-pie-chart {
        margin-top: 8px;
      }

      .mode-item {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 4px;
        font-size: 13px;
      }

      .mode-color {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        border: 1px solid rgba(0, 0, 0, 0.1);
      }

      .route-mode-item {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 4px;
        font-size: 13px;
      }

      .mode-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        border: 1px solid rgba(0, 0, 0, 0.1);
      }

      /* Analysis Module Popup Fixes */
      .maplibregl-popup-content {
        background: rgba(255, 255, 255, 0.95) !important;
        backdrop-filter: blur(20px) !important;
        border: 1px solid rgba(255, 255, 255, 0.2) !important;
        border-radius: 12px !important;
        color: #333 !important;
        font-family: "Inter", sans-serif !important;
      }

      .maplibregl-popup-tip {
        background: rgba(255, 255, 255, 0.95) !important;
        border: 1px solid rgba(255, 255, 255, 0.2) !important;
      }

      /* Deck.gl Tooltip Styling */
      .deck-tooltip {
        font-family: "Inter", sans-serif !important;
        z-index: 1000 !important;
        pointer-events: none !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
      }

      /* Deck.gl Widget Styling */
      .deck-widget,
      [class*="deck-"] {
        background: rgba(0, 0, 0, 0.8) !important;
        backdrop-filter: blur(20px) !important;
        border: 1px solid rgba(255, 255, 255, 0.3) !important;
        border-radius: 12px !important;
        color: rgba(255, 255, 255, 0.95) !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
        font-family: "Inter", sans-serif !important;
      }

      /* Ensure deck.gl controls are positioned correctly */
      .maplibregl-map .deck-widget {
        position: absolute !important;
        z-index: 1000 !important;
      }

      /* Style deck.gl control buttons */
      .deck-widget button,
      [class*="deck-"] button {
        background: transparent !important;
        border: none !important;
        color: rgba(255, 255, 255, 0.95) !important;
        transition: all 0.3s ease !important;
        border-radius: 8px !important;
        padding: 4px !important;
      }

      .deck-widget button:hover,
      [class*="deck-"] button:hover {
        background: rgba(255, 255, 255, 0.1) !important;
        color: #ffffff !important;
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        .project-title {
          font-size: 18px;
          letter-spacing: 0.3px;
        }

        .ui-panel {
          border-radius: 14px;
          padding: 12px;
        }

        .info-controls-panel {
          top: 12px;
          left: 5px;
          max-width: 300px;
          max-height: 45vh;
          overflow-y: auto;
        }

        .legend-section h3,
        .panel-title {
          font-size: 14px;
          margin-bottom: 10px;
        }

        .legend-items {
          gap: 4px;
        }
        .legend-item {
          font-size: 11px;
          gap: 6px;
        }
        .legend-color {
          width: 12px;
          height: 6px;
        }
        .gradient-bar {
          height: 14px;
        }
        .gradient-labels {
          font-size: 9px;
        }

        .analysis-narrative {
          font-size: 12px;
        }
        .analysis-btn {
          font-size: 10px;
          padding: 6px 10px;
        }

        .info-btn {
          height: 28px;
          width: 28px;
          font-size: 13px;
          border-radius: 50%;
        }

        .logo-section {
          margin-top: 10px;
          gap: 8px;
        }
        .logo-section .logo-item img {
          height: 24px;
        }
        .logo-section .logo-item.nur img {
          height: 20px;
        }
        .logo-section .logo-item.zencity img {
          height: 26px;
        }

        .info-item {
          padding: 10px;
        }
        .info-number {
          font-size: 16px;
        }
        .info-label {
          font-size: 10px;
        }
        .info-grid {
          grid-template-columns: 1fr;
          gap: 6px;
        }

        .map-controls {
          top: 12px;
          right: 12px;
          gap: 6px;
        }
        .map-control-btn {
          width: 34px;
          height: 34px;
          font-size: 16px;
          border-radius: 10px;
        }

        .maplibregl-ctrl-group {
          width: 34px !important;
          border-radius: 10px !important;
        }
        .maplibregl-ctrl-group button {
          width: 34px !important;
          height: 34px !important;
        }
        .maplibregl-ctrl-scale {
          font-size: 10px !important;
          padding: 3px 6px !important;
        }

        #map {
          height: 100vh;
          top: 0;
        }
      }

      @media (max-width: 480px) {
        .project-title {
          font-size: 16px;
        }

        .info-controls-panel {
          max-width: 300px;
          max-height: 40vh;
        }

        .legend-item {
          font-size: 10px;
        }
        .legend-color {
          width: 10px;
          height: 5px;
        }
        .gradient-bar {
          height: 12px;
        }
        .gradient-labels {
          font-size: 8px;
        }

        /* Keep findings visible on all screens; rely on panel scroll */

        .info-btn {
          height: 30px;
          font-size: 11px;
          margin-top: 8px;
        }

        .logo-section .logo-item img {
          height: 20px;
        }
        .logo-section .logo-item.nur img {
          height: 16px;
        }
        .logo-section .logo-item.zencity img {
          height: 22px;
        }

        .map-controls {
          top: 10px;
          right: 10px;
          gap: 6px;
        }
        .map-control-btn {
          width: 32px;
          height: 32px;
          font-size: 15px;
          border-radius: 10px;
        }
        .maplibregl-ctrl-group {
          width: 32px !important;
        }
        .maplibregl-ctrl-group button {
          width: 32px !important;
          height: 32px !important;
        }
        .maplibregl-ctrl-scale {
          font-size: 9px !important;
          padding: 2px 5px !important;
        }

        .info-modal-content {
          padding: 20px;
          max-width: 92vw;
        }
        .info-modal h2 {
          font-size: 20px;
        }
        .info-modal p {
          font-size: 14px;
        }

        #map {
          height: 100vh;
          top: 0;
        }
      }
    </style>
  </head>
  <body>
    <!-- Loading Overlay -->
    <div id="loading" class="loading-overlay">
      <div class="loading-content">
        <div class="loading-spinner"></div>
        <h2>Loading BGU Mobility Data...</h2>
        <p>Please wait while we prepare your interactive map</p>
      </div>
    </div>

    <!-- Map Container -->
    <div id="map"></div>

    <!-- Combined Info & Controls Panel -->
    <div class="ui-panel info-controls-panel">
      <!-- Title Section -->
      <div class="title-section">
        <h1 class="project-title">BGU Mobility Survey</h1>
      </div>

      <!-- Legend moved into Info Modal -->

      <!-- Analysis Links -->
      <div class="analysis-links">
        <ul class="analysis-narrative">
          <li>
            For
            <a href="#" data-chart="outputs/transport_modes_donut.html"
              >mode of travel</a
            >, almost two-thirds of students walk to BGU and only 5% drive
          </li>
          <li>
            Analysis of
            <a href="#" data-chart="outputs/gate_distribution.html"
              >routes to the 3 gates</a
            >
            showed that half the students enter the northern Rager gate
          </li>
          <li>
            The most important
            <a href="#" data-chart="outputs/route_choice_spider.html"
              >factor in choosing</a
            >
            a walking route was distance followed by shade
          </li>
          <li>
            <a href="#" data-chart="outputs/walking_distance.html"
              >Route analysis</a
            >
            shows that on average, BGU students walk 0.95 KM on the way to
            campus
          </li>
          <li>
            <a href="#" data-chart="outputs/distance_comparison.html"
              >Many students report</a
            >
            feeling far from campus even when living only a few hundred meters
            away!
          </li>
        </ul>
      </div>

      <!-- Logo Section -->
      <div class="logo-section">
        <div class="logo-item nur">
          <img src="assets/media/Nur Logo white.svg" alt="NUR Logo" />
        </div>
        <div class="logo-item zencity">
          <img src="assets/media/zencity white.svg" alt="ZenCity Logo" />
        </div>
        <button
          class="info-btn"
          onclick="toggleInfoModal()"
          title="Information"
          aria-label="Open information"
        >
          <i class="fas fa-info"></i>
        </button>
      </div>
    </div>

    <!-- Map Controls - Improved Vertical Stack -->
    <div class="map-controls">
      <button
        class="map-control-btn"
        onclick="resetMap()"
        title="Reset Map View"
      >
        <i class="fas fa-home"></i>
      </button>
      <button
        class="map-control-btn"
        onclick="toggleFullscreen()"
        title="Toggle Fullscreen"
      >
        <i class="fas fa-expand"></i>
      </button>
      <!-- MapLibre controls will be moved here by JavaScript -->
      <div id="maplibre-controls-container"></div>
    </div>

    <!-- Info Modal -->
    <div id="infoModal" class="info-modal">
      <div class="info-modal-content">
        <button class="info-modal-close" onclick="toggleInfoModal()">
          <i class="fas fa-times"></i>
        </button>
        <h2>About the BGU Mobility Survey</h2>
        <p style="margin-bottom: 12px; color: #444">
          Negev Urban Research conducted this mobility survey to understand the
          BGU campus relationship with the city by examining how students get to
          and from the campus, which routes they take, and what amenities they
          engage with on the way.
        </p>
        <div
          style="
            text-align: left;
            color: #333;
            font-size: 14px;
            line-height: 1.6;
            margin: 0 auto 12px auto;
            max-width: 52ch;
          "
        >
          <p style="margin: 0 0 6px 0; font-weight: 600">
            This information helps us to:
          </p>
          <ul style="margin-left: 16px; margin-bottom: 8px">
            <li>Invest in streets that students use more often</li>
            <li>
              Design interventions based on the factors students care most about
            </li>
            <li>
              Measure student interest in existing amenity clusters in the area
            </li>
          </ul>
          <p style="margin: 0">
            The survey data presented on this site was conducted in May of 2025
            with the help of the ZenCity digital platform. In total, we surveyed
            ~200 current undergraduate students from BGU (roughly 1.5% of the
            undergraduate student body) and received full responses, including
            point of origin, mode choice, and points of interest they stop at on
            the way to campus, from 115 respondents. Routes were derived using a
            shortest route algorithm generated by Open Trip Planner.
          </p>
        </div>

        <div class="legend-section" style="margin-top: 8px">
          <h3
            style="
              font-size: 16px;
              color: #222;
              display: flex;
              align-items: center;
              justify-content: flex-start;
              gap: 6px;
              margin-bottom: 8px;
            "
          >
            <i class="fas fa-layer-group" style="color: #00bcd4"></i> Legend
          </h3>
          <div
            class="legend-items legend-classic"
            style="
              color: #222;
              background: #fff;
              border: 1px solid #dcdcdc;
              border-radius: 10px;
              padding: 10px;
            "
          >
            <div style="font-size: 13px; color: #222; margin-bottom: 6px">
              Routes are colored by the campus gate they end at:
              <span style="display: inline-flex; align-items: center; gap: 6px">
                <span
                  style="
                    width: 12px;
                    height: 8px;
                    background: #22a7f0;
                    border: 1px solid #bdbdbd;
                    display: inline-block;
                  "
                ></span>
                <span>South</span>
                <span
                  style="
                    width: 12px;
                    height: 8px;
                    background: #9c5dc7;
                    border: 1px solid #bdbdbd;
                    display: inline-block;
                  "
                ></span>
                <span>North</span>
                <span
                  style="
                    width: 12px;
                    height: 8px;
                    background: #e14b31;
                    border: 1px solid #bdbdbd;
                    display: inline-block;
                  "
                ></span>
                <span>West</span>
              </span>
            </div>
            <div style="font-size: 13px; color: #222; margin-bottom: 6px">
              Line thickness reflects how many students use that segment.
            </div>
            <div style="font-size: 13px; color: #222">
              On desktop: hover to preview route usage. On mobile: tap a route
              to view usage; tap POIs or gate targets for details. Close any
              popup with the Ã— button.
            </div>
          </div>
        </div>

        <div
          style="
            text-align: left;
            color: #333;
            font-size: 14px;
            line-height: 1.6;
            margin: 12px auto 0 auto;
            max-width: 52ch;
          "
        >
          <p style="margin: 0 0 6px 0; font-weight: 600">Credits:</p>
          <ul style="margin-left: 16px; margin-bottom: 8px">
            <li>
              Merav Ferziger - Survey Design, Communication, & Data Collection
            </li>
            <li>Noam Gal - Data Analysis, Visualization, & Web Application</li>
            <li>Eran Ben Alia - Survey Design</li>
            <li>Yonatan Cohen - Visual Design, Resources</li>
            <li>Merav Battat - Leadership, Resources</li>
          </ul>
          <p style="margin: 0 0 6px 0; font-weight: 600">
            Collaborating Organizations:
          </p>
          <p style="margin: 0">NUR, ZenCity</p>
        </div>

        <div class="comment-box">
          <div class="comment-title">Comments</div>
          <textarea
            class="comment-textarea"
            placeholder="Share feedback about the analysis or map experience..."
          ></textarea>
          <button class="comment-send-btn" onclick="submitFeedback()">
            Send Feedback
          </button>
          <div class="comment-hint">
            Your note is saved to our Supabase database. If saving fails or
            Supabase is not configured, you'll see an error.
          </div>
        </div>
      </div>
    </div>

    <!-- Chart Modal -->
    <div id="chartModal" class="chart-modal" aria-hidden="true">
      <div class="chart-modal-content">
        <div class="chart-modal-header">
          <span id="chartTitle">Chart</span>
          <button
            class="chart-modal-close"
            onclick="closeChartModal()"
            aria-label="Close chart"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>
        <iframe
          id="chartFrame"
          class="chart-frame"
          src="about:blank"
          title="Chart"
        ></iframe>
      </div>
    </div>

    <!-- Config (Supabase URL & Key) -->
    <script src="./config.js"></script>
    <!-- Map Controller Script -->
    <script src="assets/js/map-controller.js"></script>
    <!-- Supabase JS (optional) -->
    <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>

    <script>
      // Supabase configuration (replace with real values or leave empty for fallback)
      const SUPABASE_URL = window.SUPABASE_URL || "";
      const SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || "";
      let supabaseClient = null;
      try {
        if (SUPABASE_URL && SUPABASE_ANON_KEY && window.supabase) {
          supabaseClient = supabase.createClient(
            SUPABASE_URL,
            SUPABASE_ANON_KEY
          );
        }
      } catch (e) {
        console.warn("Supabase initialization failed", e);
      }

      async function submitFeedback() {
        const textarea = document.querySelector(".comment-textarea");
        const note = (textarea?.value || "").trim();

        if (!note) {
          alert("Please enter a comment.");
          return;
        }

        if (!supabaseClient) {
          alert("Feedback service is not configured. Please try again later.");
          return;
        }

        try {
          const { error } = await supabaseClient.from("feedback").insert([
            {
              note,
              created_at: new Date().toISOString(),
            },
          ]);
          if (error) throw error;
          alert("Thanks for your feedback!");
          if (textarea) textarea.value = "";
        } catch (err) {
          console.error("Failed to save feedback:", err);
          alert(
            "Sorry, we couldn't save your feedback. Please try again later."
          );
        }
      }
      // Info modal functionality
      function toggleInfoModal() {
        const modal = document.getElementById("infoModal");
        modal.classList.toggle("show");
      }

      // Close modal when clicking outside
      document
        .getElementById("infoModal")
        .addEventListener("click", function (e) {
          if (e.target === this) {
            toggleInfoModal();
          }
        });

      // Close modal with escape key
      document.addEventListener("keydown", function (e) {
        if (e.key === "Escape") {
          const modal = document.getElementById("infoModal");
          if (modal.classList.contains("show")) {
            toggleInfoModal();
          }
        }
      });

      // Move MapLibre controls into the same container as custom controls
      function moveMapLibreControls() {
        const mapLibreControls = document.querySelector(
          ".maplibregl-ctrl-top-right"
        );
        const container = document.getElementById(
          "maplibre-controls-container"
        );

        if (mapLibreControls && container) {
          container.appendChild(mapLibreControls);
        } else {
          // Try again after a short delay if controls aren't ready yet
          setTimeout(moveMapLibreControls, 100);
        }
      }

      // Wait for the map to be initialized and controls to be created
      document.addEventListener("DOMContentLoaded", function () {
        // Give the map time to initialize
        setTimeout(moveMapLibreControls, 500);
        // Chart modal handlers for analysis links
        document.querySelectorAll("[data-chart]")?.forEach((el) => {
          el.addEventListener("click", function (e) {
            e.preventDefault();
            const url = this.getAttribute("data-chart");
            if (!url) return;
            openChartModal(url, this.textContent?.trim() || "Chart");
          });
        });
      });

      function openChartModal(url, title) {
        const modal = document.getElementById("chartModal");
        const frame = document.getElementById("chartFrame");
        const chartTitle = document.getElementById("chartTitle");
        console.assert(!!modal && !!frame, "Chart modal elements must exist");
        frame.src = url;
        chartTitle.textContent = title;
        modal.classList.add("show");
      }

      function closeChartModal() {
        const modal = document.getElementById("chartModal");
        const frame = document.getElementById("chartFrame");
        if (modal && frame) {
          frame.src = "about:blank";
          modal.classList.remove("show");
        }
      }

      // Close chart modal on overlay click and Escape
      document.addEventListener("click", function (e) {
        const modal = document.getElementById("chartModal");
        if (e.target === modal) {
          closeChartModal();
        }
      });
      document.addEventListener("keydown", function (e) {
        if (e.key === "Escape") {
          closeChartModal();
        }
      });
    </script>
  </body>
</html>
