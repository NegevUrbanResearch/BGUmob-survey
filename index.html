<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BGU Mobility Survey - Interactive POI Map</title>
    <link rel="icon" href="assets/media/favicon.ico" sizes="any" />
    <link
      rel="shortcut icon"
      href="assets/media/favicon.ico"
      type="image/x-icon"
    />

    <!-- MapLibre GL JS -->
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link
      href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css"
      rel="stylesheet"
    />

    <!-- deck.gl -->
    <script src="https://unpkg.com/deck.gl@^9.0.0/dist.min.js"></script>

    <!-- Inter Font -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Font Awesome for icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
        background: #f5f5f5;
        color: #333333;
        overflow: hidden;
        height: 100vh;
      }

      .info-btn {
        height: 30px;
        width: 30px;
        padding: 0;
        background: linear-gradient(
          135deg,
          rgba(100, 255, 218, 0.2),
          rgba(0, 188, 212, 0.1)
        );
        backdrop-filter: blur(12px);
        border: 1px solid rgba(100, 255, 218, 0.35);
        border-radius: 50%;
        color: #64ffda;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0;
        box-shadow: 0 4px 12px rgba(100, 255, 218, 0.2);
        line-height: 1;
        white-space: nowrap;
      }

      .info-btn:hover {
        background: linear-gradient(
          135deg,
          rgba(100, 255, 218, 0.3),
          rgba(0, 188, 212, 0.2)
        );
        border-color: rgba(100, 255, 218, 0.5);
        color: #ffffff;
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(100, 255, 218, 0.3);
      }

      #map {
        width: 100vw;
        height: 100vh;
        position: relative;
        top: 0;
      }

      /* Smooth transitions for map layers */
      .maplibregl-map .maplibregl-canvas {
        transition: filter 0.2s ease;
      }

      /* Enhanced rendering for smooth overlapping lines */
      .maplibregl-map {
        image-rendering: auto;
        image-rendering: -webkit-optimize-contrast;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      /* Force hardware acceleration for smoother rendering */
      .maplibregl-canvas {
        will-change: transform;
        transform: translateZ(0);
      }

      /* Glass Panel Base - Dark Mode */
      .ui-panel {
        position: absolute;
        background: linear-gradient(
          135deg,
          rgba(15, 18, 20, 0.85),
          rgba(20, 22, 24, 0.75)
        );
        backdrop-filter: blur(18px) saturate(140%);
        -webkit-backdrop-filter: blur(18px) saturate(140%);
        border: 1px solid rgba(255, 255, 255, 0.16);
        border-radius: 18px;
        padding: 20px;
        z-index: 1000;
        transition: background 0.3s ease, transform 0.3s ease,
          border-color 0.3s ease, box-shadow 0.3s ease;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.45),
          inset 0 1px 0 rgba(255, 255, 255, 0.06);
      }

      .ui-panel:hover {
        background: linear-gradient(
          135deg,
          rgba(15, 18, 20, 0.9),
          rgba(20, 22, 24, 0.8)
        );
        transform: translateY(-2px);
        border-color: rgba(255, 255, 255, 0.22);
        box-shadow: 0 14px 48px rgba(0, 0, 0, 0.5),
          inset 0 1px 0 rgba(255, 255, 255, 0.08);
      }

      /* Title Section */
      .title-section {
        margin-bottom: 20px;
      }

      .project-title {
        background: linear-gradient(135deg, #64ffda, #00bcd4);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        font-size: 28px;
        text-align: center;
        font-weight: 700;
        letter-spacing: 0.5px;
        text-shadow: 0 2px 4px rgba(100, 255, 218, 0.2);
        position: relative;
        margin: 0;
      }

      .project-title::after {
        content: "";
        position: absolute;
        bottom: -4px;
        left: 0;
        width: 100%;
        height: 2px;
        background: linear-gradient(90deg, transparent, #64ffda, transparent);
        border-radius: 1px;
      }

      /* Logo Section in Control Panel */
      .logo-section {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 10px;
        justify-content: center;
        flex-wrap: wrap;
      }

      .logo-section .logo-item {
        display: flex;
        align-items: center;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .logo-section .logo-item:hover {
        transform: scale(1.05);
      }

      .logo-section .logo-item img {
        height: 40px;
        width: auto;
        object-fit: contain;
      }

      .logo-section .logo-item.nur img {
        height: 35px;
        filter: brightness(0) invert(1); /* Make NUR logo white */
      }

      .logo-section .logo-item.zencity img {
        height: 45px;
        /* Preserve ZenCity logo colors - no filter */
      }

      /* Combined Info & Controls Panel */
      .info-controls-panel {
        top: 5px;
        left: 5px;
        max-width: 360px;
      }

      .panel-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 16px;
        color: #ffffff;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .info-section {
        margin-bottom: 12px;
      }

      .info-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-bottom: 14px;
      }

      .info-item {
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 12px;
        padding: 12px;
        text-align: center;
      }

      .info-number {
        font-size: 24px;
        font-weight: 700;
        color: #64ffda;
        display: block;
        margin-bottom: 4px;
      }

      .info-label {
        font-size: 13px;
        color: rgba(255, 255, 255, 0.7);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 500;
      }

      /* Gradient Legend */
      .legend-gradient {
        margin-bottom: 16px;
      }

      .gradient-bar {
        height: 20px;
        background: linear-gradient(
          to right,
          #004d00,
          #006400,
          #228b22,
          #32cd32,
          #90ee90
        );
        border-radius: 10px;
        margin-bottom: 8px;
        border: 1px solid rgba(255, 255, 255, 0.3);
      }

      .gradient-labels {
        display: flex;
        justify-content: space-between;
        font-size: 12px;
        color: rgba(255, 255, 255, 0.9);
      }

      /* Legend Section (moved into modal) */
      .legend-section {
        margin-bottom: 16px;
        padding-bottom: 12px;
        position: relative;
      }

      .legend-section::after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 2px;
        background: linear-gradient(90deg, transparent, #64ffda, transparent);
        border-radius: 1px;
      }

      .legend-items {
        display: flex;
        align-items: center;
        flex-direction: column;
        gap: 6px;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        color: rgba(255, 255, 255, 0.95);
        font-weight: 500;
      }

      .legend-color {
        width: 16px;
        height: 8px;
        border-radius: 2px;
        border: 1px solid rgba(255, 255, 255, 0.3);
      }

      .legend-label {
        flex: 1;
      }

      /* Classic boxed legend style inside info modal */
      .legend-classic .legend-item {
        width: 100%;
        background: #ffffff;
        border: 1px solid #dcdcdc;
        border-radius: 8px;
        padding: 8px 10px;
        color: #222;
      }
      .legend-classic .legend-color {
        border: 1px solid #bdbdbd;
      }

      /* Map Controls - Improved Vertical Stack */
      .map-controls {
        position: absolute;
        top: 20px;
        right: 20px;
        z-index: 1001;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .map-control-btn {
        width: 40px;
        height: 40px;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 12px;
        color: rgba(255, 255, 255, 0.95);
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .map-control-btn:hover {
        background: rgba(0, 0, 0, 0.9);
        transform: translateY(-1px);
      }

      /* MapLibre Controls Styling - In Same Container */
      .maplibregl-ctrl-top-right {
        position: static !important;
        margin: 0 !important;
      }

      .maplibregl-ctrl-bottom-right {
        bottom: 20px !important;
        right: 20px !important;
      }

      .maplibregl-ctrl-group {
        background: rgba(0, 0, 0, 0.8) !important;
        backdrop-filter: blur(20px) !important;
        -webkit-backdrop-filter: blur(20px) !important;
        border: 1px solid rgba(255, 255, 255, 0.3) !important;
        border-radius: 12px !important;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3) !important;
        width: 40px !important;
        margin-bottom: 8px !important;
      }

      /* Remove margin when MapLibre controls are inside our container */
      .map-controls .maplibregl-ctrl-group {
        margin-bottom: 0 !important;
        margin-top: 0 !important;
      }

      .maplibregl-ctrl-group button {
        background: transparent !important;
        border: none !important;
        color: rgba(255, 255, 255, 0.95) !important;
        transition: all 0.3s ease !important;
        width: 40px !important;
        height: 40px !important;
      }

      .maplibregl-ctrl-group button:hover {
        background: rgba(255, 255, 255, 0.1) !important;
        color: #ffffff !important;
        transform: translateY(-1px) !important;
      }

      /* Enhance compass visibility on dark background */
      .maplibregl-ctrl-bottom-right .maplibregl-ctrl-group.compass-group {
        background: rgba(0, 0, 0, 0.9) !important;
        border: 1px solid rgba(100, 255, 218, 0.35) !important;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.45),
          0 0 0 1px rgba(100, 255, 218, 0.1) inset !important;
      }
      .maplibregl-ctrl-bottom-right
        .maplibregl-ctrl-group.compass-group
        .maplibregl-ctrl-icon {
        filter: invert(1) brightness(1.4)
          drop-shadow(0 0 4px rgba(100, 255, 218, 0.45)) !important;
      }
      .maplibregl-ctrl-bottom-right
        .maplibregl-ctrl-group.compass-group
        button:hover {
        background: rgba(100, 255, 218, 0.12) !important;
      }

      /* Simple filter approach for MapLibre control icons - inverts them to white */
      .maplibregl-ctrl-zoom-in .maplibregl-ctrl-icon,
      .maplibregl-ctrl-zoom-out .maplibregl-ctrl-icon,
      .maplibregl-ctrl-compass .maplibregl-ctrl-icon {
        filter: invert(1) brightness(1.2) !important;
      }

      .maplibregl-ctrl-group button:first-child {
        border-top-left-radius: 12px !important;
        border-top-right-radius: 12px !important;
      }

      .maplibregl-ctrl-group button:last-child {
        border-bottom-left-radius: 12px !important;
        border-bottom-right-radius: 12px !important;
      }

      .maplibregl-ctrl-scale {
        background: rgba(0, 0, 0, 0.8) !important;
        backdrop-filter: blur(20px) !important;
        -webkit-backdrop-filter: blur(20px) !important;
        border: 1px solid rgba(255, 255, 255, 0.3) !important;
        border-radius: 8px !important;
        color: rgba(255, 255, 255, 0.95) !important;
        padding: 4px 8px !important;
        font-size: 13px !important;
        font-family: "Inter", sans-serif !important;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2) !important;
      }

      /* Loading Overlay */
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        transition: opacity 0.5s ease;
      }

      .loading-content {
        text-align: center;
        color: #ffffff;
      }

      .loading-spinner {
        width: 50px;
        height: 50px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-top: 3px solid #64ffda;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Analysis Links */
      .analysis-links {
        margin-top: 16px;
      }

      .analysis-links h3 {
        font-size: 22px;
        font-weight: 600;
        margin-bottom: 12px;
        color: rgba(255, 255, 255, 0.95);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .analysis-btn {
        display: block;
        width: 100%;
        padding: 8px 12px;
        background: rgba(255, 255, 255, 0.15);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 12px;
        color: rgba(255, 255, 255, 0.95);
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: left;
        margin-bottom: 6px;
        text-decoration: none;
      }

      .analysis-btn:hover {
        background: rgba(255, 255, 255, 0.25);
        transform: translateX(2px);
      }

      /* Narrative style for Analysis section */
      .analysis-narrative {
        font-size: 15px;
        color: rgba(255, 255, 255, 0.95);
        line-height: 1.7;
      }

      .analysis-narrative a {
        color: #64ffda;
        font-weight: 600;
        text-decoration: none;
        border-bottom: 1px dashed rgba(100, 255, 218, 0.6);
        transition: color 0.2s ease, border-color 0.2s ease;
      }

      .analysis-narrative a:hover {
        color: #ffffff;
        border-bottom-color: #ffffff;
      }

      /* Add spacing between narrative bullet points */
      .analysis-narrative li {
        margin-bottom: 10px;
      }
      .analysis-narrative li:last-child {
        margin-bottom: 0;
      }

      /* Enhanced Info Modal */
      .info-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        backdrop-filter: blur(8px);
        opacity: 0;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .info-modal.show {
        display: flex;
        opacity: 1;
      }

      .info-modal-content {
        background: linear-gradient(
          145deg,
          rgba(10, 15, 20, 0.98),
          rgba(20, 25, 30, 0.95)
        );
        backdrop-filter: blur(30px) saturate(120%);
        -webkit-backdrop-filter: blur(30px) saturate(120%);
        border: 2px solid rgba(100, 255, 218, 0.2);
        border-radius: 24px;
        padding: 0;
        max-width: min(92vw, 800px);
        max-height: min(90vh, 850px);
        position: relative;
        box-shadow: 0 25px 80px rgba(0, 0, 0, 0.6),
          0 0 0 1px rgba(100, 255, 218, 0.1) inset,
          0 5px 20px rgba(100, 255, 218, 0.15);
        overflow: hidden;
        transform: scale(0.9);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .info-modal.show .info-modal-content {
        transform: scale(1);
      }

      /* Modal Header */
      .info-modal-header {
        background: linear-gradient(
          135deg,
          rgba(100, 255, 218, 0.15),
          rgba(0, 188, 212, 0.1)
        );
        border-bottom: 1px solid rgba(100, 255, 218, 0.2);
        padding: 24px 32px;
        position: relative;
      }

      .info-modal-close {
        position: absolute;
        top: 20px;
        right: 24px;
        width: 36px;
        height: 36px;
        background: rgba(100, 255, 218, 0.15);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(100, 255, 218, 0.3);
        border-radius: 50%;
        color: #ffffff;
        font-size: 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 10;
      }

      .info-modal-close:hover {
        background: rgba(100, 255, 218, 0.25);
        border-color: rgba(100, 255, 218, 0.5);
        transform: scale(1.05);
        box-shadow: 0 4px 15px rgba(100, 255, 218, 0.3);
      }

      .info-modal-title {
        background: linear-gradient(135deg, #64ffda, #00bcd4);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        font-size: 28px;
        font-weight: 700;
        margin: 0;
        letter-spacing: -0.5px;
        position: relative;
      }

      .info-modal-subtitle {
        color: rgba(255, 255, 255, 0.8);
        font-size: 16px;
        font-weight: 500;
        margin-top: 8px;
        letter-spacing: 0.3px;
      }

      /* Modal Body with Custom Scrollbar */
      .info-modal-body {
        padding: 0;
        max-height: calc(90vh - 120px);
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: rgba(100, 255, 218, 0.3) transparent;
      }

      .info-modal-body::-webkit-scrollbar {
        width: 6px;
      }

      .info-modal-body::-webkit-scrollbar-track {
        background: transparent;
      }

      .info-modal-body::-webkit-scrollbar-thumb {
        background: rgba(100, 255, 218, 0.3);
        border-radius: 3px;
      }

      .info-modal-body::-webkit-scrollbar-thumb:hover {
        background: rgba(100, 255, 218, 0.5);
      }

      .info-content-section {
        padding: 24px 32px;
      }

      /* How to Use Section Styling */
      .how-to-use-section {
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        padding: 24px 32px 20px 32px;
        margin-bottom: 0;
      }

      .how-to-use-section h3 {
        font-size: 18px;
        font-weight: 600;
        color: #64ffda;
        margin: 0 0 20px 0;
      }

      /* Usage Narrative Styling */
      .usage-narrative {
        color: rgba(255, 255, 255, 0.9);
        font-size: 15px;
        line-height: 1.7;
      }

      .usage-narrative p {
        margin: 0 0 20px 0;
        color: rgba(255, 255, 255, 0.9);
      }

      .usage-narrative p:last-child {
        margin-bottom: 0;
      }

      .usage-narrative strong {
        color: #64ffda;
        font-weight: 600;
      }

      .usage-narrative span {
        display: inline;
      }

      /* Content Sections Styling */
      .content-section {
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        padding: 24px 32px;
      }

      .content-section h3 {
        font-size: 18px;
        font-weight: 600;
        color: #64ffda;
        margin: 0 0 16px 0;
      }

      .content-section p {
        color: rgba(255, 255, 255, 0.9);
        font-size: 15px;
        line-height: 1.6;
        margin: 0 0 16px 0;
      }

      .content-section p:last-child {
        margin-bottom: 0;
      }

      .content-section ul {
        margin: 12px 0;
        padding-left: 20px;
      }

      .content-section li {
        margin-bottom: 8px;
        color: rgba(255, 255, 255, 0.85);
        font-size: 15px;
        line-height: 1.6;
      }

      .content-section li:last-child {
        margin-bottom: 0;
      }

      /* Credits Section Styling */
      .credits-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 12px;
        margin-top: 12px;
      }

      .credit-item {
        padding: 8px 0;
      }

      .credit-name {
        font-size: 15px;
        font-weight: 600;
        color: #64ffda;
        margin-bottom: 4px;
      }

      .credit-role {
        font-size: 13px;
        color: rgba(255, 255, 255, 0.75);
        line-height: 1.4;
      }

      /* Comment Section */
      .comment-section {
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        padding: 24px 32px;
      }

      .comment-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
      }

      .comment-section h3 {
        font-size: 18px;
        font-weight: 600;
        color: #64ffda;
        margin: 0;
      }

      .comment-form {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .comment-textarea {
        width: 100%;
        min-height: 100px;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        padding: 16px;
        color: #ffffff;
        font-family: "Inter", sans-serif;
        font-size: 14px;
        line-height: 1.6;
        resize: vertical;
        transition: all 0.3s ease;
      }

      .comment-textarea:focus {
        outline: none;
        border-color: rgba(100, 255, 218, 0.5);
        background: rgba(255, 255, 255, 0.12);
        box-shadow: 0 0 0 3px rgba(100, 255, 218, 0.15);
      }

      .comment-textarea::placeholder {
        color: rgba(255, 255, 255, 0.5);
      }

      .comment-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 12px;
      }

      .comment-hint {
        font-size: 12px;
        color: rgba(255, 255, 255, 0.6);
        flex: 1;
        min-width: 200px;
      }

      .comment-send-btn {
        background: linear-gradient(135deg, #64ffda, #00bcd4);
        border: none;
        color: #0a0e10;
        font-weight: 600;
        font-size: 14px;
        padding: 12px 24px;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 4px 15px rgba(100, 255, 218, 0.3);
      }

      .comment-send-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 25px rgba(100, 255, 218, 0.4);
        filter: brightness(1.1);
      }

      .comment-send-btn:active {
        transform: translateY(0);
      }

      /* Popup Styling */
      .poi-popup,
      .gate-popup,
      .route-popup {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        padding: 16px;
        color: #333;
        font-family: "Inter", sans-serif;
        max-width: 250px;
      }

      /* Chart Modal */
      .chart-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        backdrop-filter: blur(5px);
      }

      .chart-modal.show {
        display: flex;
      }

      .chart-modal-content {
        background: #0f1214;
        border: 1px solid rgba(255, 255, 255, 0.16);
        border-radius: 16px;
        width: min(92vw, 1100px);
        height: min(86vh, 800px);
        position: relative;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        overflow: hidden;
      }

      .chart-modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 14px;
        background: rgba(255, 255, 255, 0.06);
        color: #fff;
        font-weight: 600;
        font-size: 14px;
      }

      .chart-modal-close {
        background: rgba(100, 255, 218, 0.2);
        border: none;
        color: #fff;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        cursor: pointer;
      }

      .chart-frame {
        width: 100%;
        height: calc(100% - 50px);
        border: 0;
        background: #0f1214;
      }

      .poi-popup h4,
      .gate-popup h4,
      .route-popup h4 {
        color: #2c3e50;
        margin: 0 0 8px 0;
        font-size: 14px;
        font-weight: 600;
      }

      .poi-comment {
        color: #666;
        font-style: italic;
        margin: 0;
        font-size: 12px;
      }

      .mode-pie-chart {
        margin-top: 8px;
      }

      .mode-item {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 4px;
        font-size: 13px;
      }

      .mode-color {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        border: 1px solid rgba(0, 0, 0, 0.1);
      }

      .route-mode-item {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 4px;
        font-size: 13px;
      }

      .mode-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        border: 1px solid rgba(0, 0, 0, 0.1);
      }

      /* Analysis Module Popup Fixes */
      .maplibregl-popup-content {
        background: rgba(0, 0, 0, 0.95) !important;
        backdrop-filter: blur(20px) !important;
        border: none !important;
        border-radius: 8px !important;
        color: #e8eaed !important;
        font-family: "Inter", sans-serif !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
      }

      .maplibregl-popup-tip {
        background: rgba(0, 0, 0, 0.95) !important;
        border: none !important;
      }

      /* Deck.gl Tooltip Styling */
      .deck-tooltip {
        font-family: "Inter", sans-serif !important;
        z-index: 1000 !important;
        pointer-events: none !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
      }

      /* Deck.gl Widget Styling */
      .deck-widget,
      [class*="deck-"] {
        background: rgba(0, 0, 0, 0.8) !important;
        backdrop-filter: blur(20px) !important;
        border: 1px solid rgba(255, 255, 255, 0.3) !important;
        border-radius: 12px !important;
        color: rgba(255, 255, 255, 0.95) !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
        font-family: "Inter", sans-serif !important;
      }

      /* Ensure deck.gl controls are positioned correctly */
      .maplibregl-map .deck-widget {
        position: absolute !important;
        z-index: 1000 !important;
      }

      /* Style deck.gl control buttons */
      .deck-widget button,
      [class*="deck-"] button {
        background: transparent !important;
        border: none !important;
        color: rgba(255, 255, 255, 0.95) !important;
        transition: all 0.3s ease !important;
        border-radius: 8px !important;
        padding: 4px !important;
      }

      .deck-widget button:hover,
      [class*="deck-"] button:hover {
        background: rgba(255, 255, 255, 0.1) !important;
        color: #ffffff !important;
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        .project-title {
          font-size: 18px;
          letter-spacing: 0.3px;
        }

        .ui-panel {
          border-radius: 14px;
          padding: 12px;
        }

        .info-controls-panel {
          top: 12px;
          left: 5px;
          max-width: 300px;
          max-height: 45vh;
          overflow-y: auto;
        }

        .legend-section h3,
        .panel-title {
          font-size: 14px;
          margin-bottom: 10px;
        }

        .legend-items {
          gap: 4px;
        }
        .legend-item {
          font-size: 11px;
          gap: 6px;
        }
        .legend-color {
          width: 12px;
          height: 6px;
        }
        .gradient-bar {
          height: 14px;
        }
        .gradient-labels {
          font-size: 9px;
        }

        .analysis-narrative {
          font-size: 12px;
        }
        .analysis-btn {
          font-size: 10px;
          padding: 6px 10px;
        }

        .info-btn {
          height: 28px;
          width: 28px;
          font-size: 13px;
          border-radius: 50%;
        }

        .logo-section {
          margin-top: 10px;
          gap: 8px;
        }
        .logo-section .logo-item img {
          height: 24px;
        }
        .logo-section .logo-item.nur img {
          height: 20px;
        }
        .logo-section .logo-item.zencity img {
          height: 26px;
        }

        .info-item {
          padding: 10px;
        }
        .info-number {
          font-size: 16px;
        }
        .info-label {
          font-size: 10px;
        }
        .info-grid {
          grid-template-columns: 1fr;
          gap: 6px;
        }

        .map-controls {
          top: 12px;
          right: 12px;
          gap: 6px;
        }
        .map-control-btn {
          width: 34px;
          height: 34px;
          font-size: 16px;
          border-radius: 10px;
        }

        .maplibregl-ctrl-group {
          width: 34px !important;
          border-radius: 10px !important;
        }
        .maplibregl-ctrl-group button {
          width: 34px !important;
          height: 34px !important;
        }
        .maplibregl-ctrl-scale {
          font-size: 10px !important;
          padding: 3px 6px !important;
        }

        /* Modal Responsive */
        .info-modal-content {
          max-width: 95vw;
          max-height: 95vh;
          border-radius: 20px;
        }

        .info-modal-header {
          padding: 20px 24px;
        }

        .info-modal-title {
          font-size: 24px;
        }

        .info-content-section {
          padding: 20px 24px;
        }

        .comment-section {
          padding: 20px 24px;
        }

        .legend-gates {
          flex-direction: column;
          align-items: center;
        }

        .credits-grid {
          grid-template-columns: 1fr;
        }

        #map {
          height: 100vh;
          top: 0;
        }
      }

      @media (max-width: 480px) {
        .project-title {
          font-size: 16px;
        }

        .info-controls-panel {
          max-width: 300px;
          max-height: 40vh;
        }

        .legend-item {
          font-size: 10px;
        }
        .legend-color {
          width: 10px;
          height: 5px;
        }
        .gradient-bar {
          height: 12px;
        }
        .gradient-labels {
          font-size: 8px;
        }

        .info-btn {
          height: 30px;
          font-size: 11px;
          margin-top: 8px;
        }

        .logo-section .logo-item img {
          height: 20px;
        }
        .logo-section .logo-item.nur img {
          height: 16px;
        }
        .logo-section .logo-item.zencity img {
          height: 22px;
        }

        .map-controls {
          top: 10px;
          right: 10px;
          gap: 6px;
        }
        .map-control-btn {
          width: 32px;
          height: 32px;
          font-size: 15px;
          border-radius: 10px;
        }
        .maplibregl-ctrl-group {
          width: 32px !important;
        }
        .maplibregl-ctrl-group button {
          width: 32px !important;
          height: 32px !important;
        }
        .maplibregl-ctrl-scale {
          font-size: 9px !important;
          padding: 2px 5px !important;
        }

        /* Modal Mobile */
        .info-modal-content {
          max-width: 98vw;
          max-height: 98vh;
          border-radius: 16px;
        }

        .info-modal-header {
          padding: 16px 20px;
        }

        .info-modal-title {
          font-size: 20px;
        }

        .info-modal-subtitle {
          font-size: 14px;
        }

        .info-content-section {
          padding: 16px 20px;
        }

        .comment-section {
          padding: 16px 20px;
        }

        .comment-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 10px;
        }

        .comment-section h3 {
          font-size: 16px;
        }

        .how-to-use-section {
          padding: 20px 24px 16px 24px;
        }

        .how-to-use-section h3 {
          font-size: 16px;
          margin-bottom: 16px;
        }

        .usage-narrative {
          font-size: 14px;
          line-height: 1.6;
        }

        .usage-narrative p {
          margin-bottom: 16px;
        }

        .content-section {
          padding: 20px 24px;
        }

        .content-section h3 {
          font-size: 16px;
          margin-bottom: 12px;
        }

        .content-section p,
        .content-section li {
          font-size: 14px;
        }

        .credits-grid {
          grid-template-columns: 1fr;
          gap: 10px;
        }

        .credit-item {
          padding: 6px 0;
        }

        .credit-name {
          font-size: 14px;
        }

        .credit-role {
          font-size: 12px;
        }

        .how-to-use-section {
          padding: 16px 20px 12px 20px;
        }

        .how-to-use-section h3 {
          font-size: 14px;
          margin-bottom: 12px;
        }

        .usage-narrative {
          font-size: 13px;
          line-height: 1.5;
        }

        .usage-narrative p {
          margin-bottom: 14px;
        }

        .content-section {
          padding: 16px 20px;
        }

        .content-section h3 {
          font-size: 14px;
          margin-bottom: 10px;
        }

        .content-section p,
        .content-section li {
          font-size: 13px;
        }

        .credits-grid {
          grid-template-columns: 1fr;
          gap: 8px;
        }

        .credit-item {
          padding: 4px 0;
        }

        .credit-name {
          font-size: 13px;
        }

        .credit-role {
          font-size: 11px;
        }

        #map {
          height: 100vh;
          top: 0;
        }
      }
    </style>
  </head>
  <body>
    <!-- Loading Overlay -->
    <div id="loading" class="loading-overlay">
      <div class="loading-content">
        <div class="loading-spinner"></div>
        <h2>Loading BGU Mobility Data...</h2>
        <p>Please wait while we prepare your interactive map</p>
      </div>
    </div>

    <!-- Map Container -->
    <div id="map"></div>

    <!-- Combined Info & Controls Panel -->
    <div class="ui-panel info-controls-panel">
      <!-- Title Section -->
      <div class="title-section">
        <h1 class="project-title">BGU Mobility Survey</h1>
      </div>

      <!-- Analysis Links -->
      <div class="analysis-links">
        <ul class="analysis-narrative">
          <li>
            For
            <a href="#" data-chart="outputs/transport_modes_donut.html"
              >mode of travel</a
            >, almost two-thirds of students walk to BGU and only 5% drive
          </li>
          <li>
            Analysis of
            <a href="#" data-chart="outputs/gate_distribution.html"
              >routes to the 3 gates</a
            >
            showed that half the students enter the northern Rager gate
          </li>
          <li>
            The most important
            <a href="#" data-chart="outputs/route_choice_spider.html"
              >factor in choosing</a
            >
            a walking route was distance followed by shade
          </li>
          <li id="walking-stats-bullet" style="display: none">
            For
            <a href="#" data-chart="outputs/walking_distance.html"
              >walking trips</a
            >, the longest trip is
            <span id="walking-max">—</span>
            kilometers and 50% of walking trips are within
            <span id="walking-median">—</span>
            kilometers
          </li>
          <li>
            <a href="#" data-chart="outputs/distance_comparison.html"
              >Many students report</a
            >
            feeling far from campus even when living only a few hundred meters
            away!
          </li>
        </ul>
      </div>

      <!-- Logo Section -->
      <div class="logo-section">
        <div class="logo-item nur">
          <img src="assets/media/Nur Logo white.svg" alt="NUR Logo" />
        </div>
        <div class="logo-item zencity">
          <img src="assets/media/zencity white.svg" alt="ZenCity Logo" />
        </div>
        <button
          class="info-btn"
          onclick="toggleInfoModal()"
          title="Information"
          aria-label="Open information"
        >
          <i class="fas fa-info"></i>
        </button>
      </div>
    </div>

    <!-- Map Controls - Improved Vertical Stack -->
    <div class="map-controls">
      <button
        class="map-control-btn"
        onclick="resetMap()"
        title="Reset Map View"
      >
        <i class="fas fa-home"></i>
      </button>
      <button
        class="map-control-btn"
        onclick="toggleFullscreen()"
        title="Toggle Fullscreen"
      >
        <i class="fas fa-expand"></i>
      </button>
      <!-- MapLibre controls will be moved here by JavaScript -->
      <div id="maplibre-controls-container"></div>
    </div>

    <!-- Enhanced Info Modal -->
    <div id="infoModal" class="info-modal">
      <div class="info-modal-content">
        <!-- Modal Header -->
        <div class="info-modal-header">
          <button class="info-modal-close" onclick="toggleInfoModal()">
            <i class="fas fa-times"></i>
          </button>
          <h2 class="info-modal-title">BGU Mobility Survey</h2>
          <p class="info-modal-subtitle">
            Understanding campus connectivity through student movement patterns
          </p>
        </div>

        <!-- Modal Body -->
        <div class="info-modal-body">
          <!-- How to Use -->
          <div class="how-to-use-section">
            <h3>How to Use This Interactive Map</h3>
            <div class="usage-narrative">
              <p>
                <strong>What you see:</strong> Routes are colored by destination
                gate —
                <span
                  style="
                    display: inline-flex;
                    align-items: center;
                    gap: 6px;
                    margin-right: 8px;
                  "
                >
                  <svg
                    width="14"
                    height="14"
                    viewBox="0 0 48 48"
                    aria-label="South Gate"
                    style="vertical-align: middle"
                  >
                    <circle
                      cx="24"
                      cy="24"
                      r="20"
                      stroke="#22a7f0"
                      stroke-width="4"
                      fill="rgba(255,255,255,0.95)"
                    />
                    <circle
                      cx="24"
                      cy="24"
                      r="12"
                      stroke="#22a7f0"
                      stroke-width="4"
                      fill="none"
                    />
                    <circle
                      cx="24"
                      cy="24"
                      r="4"
                      stroke="#22a7f0"
                      stroke-width="4"
                      fill="#22a7f0"
                    />
                  </svg>
                  <span>South Gate</span>
                </span>
                <span
                  style="
                    display: inline-flex;
                    align-items: center;
                    gap: 6px;
                    margin-right: 8px;
                  "
                >
                  <svg
                    width="14"
                    height="14"
                    viewBox="0 0 48 48"
                    aria-label="North Gate"
                    style="vertical-align: middle"
                  >
                    <circle
                      cx="24"
                      cy="24"
                      r="20"
                      stroke="#9c5dc7"
                      stroke-width="4"
                      fill="rgba(255,255,255,0.95)"
                    />
                    <circle
                      cx="24"
                      cy="24"
                      r="12"
                      stroke="#9c5dc7"
                      stroke-width="4"
                      fill="none"
                    />
                    <circle
                      cx="24"
                      cy="24"
                      r="4"
                      stroke="#9c5dc7"
                      stroke-width="4"
                      fill="#9c5dc7"
                    />
                  </svg>
                  <span>North Gate</span>
                </span>
                <span
                  style="display: inline-flex; align-items: center; gap: 6px"
                >
                  <svg
                    width="14"
                    height="14"
                    viewBox="0 0 48 48"
                    aria-label="West Gate"
                    style="vertical-align: middle"
                  >
                    <circle
                      cx="24"
                      cy="24"
                      r="20"
                      stroke="#e14b31"
                      stroke-width="4"
                      fill="rgba(255,255,255,0.95)"
                    />
                    <circle
                      cx="24"
                      cy="24"
                      r="12"
                      stroke="#e14b31"
                      stroke-width="4"
                      fill="none"
                    />
                    <circle
                      cx="24"
                      cy="24"
                      r="4"
                      stroke="#e14b31"
                      stroke-width="4"
                      fill="#e14b31"
                    />
                  </svg>
                  <span>West Gate</span>
                </span>
              </p>

              <p>
                <strong>Interact:</strong> Click/Hover over a route to see trip
                counts and mode labels (e.g., Walking, Driving). Click/Hover
                over a
                <svg
                  width="21"
                  height="21"
                  viewBox="0 0 64 64"
                  aria-label="POI"
                  style="vertical-align: middle"
                >
                  <path
                    d="M32 6c-8.8 0-16 7.2-16 16 0 11.046 16 30 16 30s16-18.954 16-30c0-8.8-7.2-16-16-16z"
                    fill="#4CAF50"
                    stroke="#1B5E20"
                    stroke-width="4"
                  />
                  <circle cx="32" cy="22" r="7" fill="#FFFFFF" />
                </svg>
                POI to read its note. Click/Hover over a gate to see how many
                trips end there.
              </p>

              <p>
                <strong>Go deeper:</strong> Review the findings in the left
                panel and use the links to open detailed charts that summarize
                survey response data.
              </p>
            </div>
          </div>

          <!-- About This Research -->
          <div class="content-section">
            <h3>About This Research</h3>
            <p>
              Negev Urban Research conducted this mobility survey to understand
              the BGU campus relationship with Beer Sheva by examining how
              students get to and from campus, which routes they take, and what
              amenities they engage with along the way.
            </p>
          </div>

          <!-- Research Goals -->
          <div class="content-section">
            <h3>Research Goals</h3>
            <p>This information helps us to:</p>
            <ul>
              <li>
                Invest in streets and infrastructure that students use more
                often
              </li>
              <li>
                Design urban interventions based on factors students care most
                about
              </li>
              <li>
                Measure student interest in existing amenity clusters in the
                surrounding area
              </li>
              <li>
                Inform policy decisions about campus accessibility and urban
                planning
              </li>
            </ul>
          </div>

          <!-- Survey Methodology -->
          <div class="content-section">
            <h3>Survey Methodology</h3>
            <p>
              The survey data was conducted in May 2025 with the help of the
              ZenCity digital platform. We surveyed approximately 200 current
              undergraduate students from BGU (roughly 1.5% of the undergraduate
              student body) and received complete responses from 115
              respondents.
            </p>
            <p>
              Data collected includes points of origin, transportation mode
              choices, destination gates, and points of interest visited along
              routes to campus. Routes were derived using a shortest route
              algorithm generated by Open Trip Planner.
            </p>
          </div>

          <!-- Research Team -->
          <div class="content-section">
            <h3>Credits</h3>
            <div class="credits-grid">
              <div class="credit-item">
                <div class="credit-name">Merav Ferziger</div>
                <div class="credit-role">
                  Survey Design, Communication & Data Collection
                </div>
              </div>
              <div class="credit-item">
                <div class="credit-name">Noam Gal</div>
                <div class="credit-role">
                  Data Analysis, Visualization & Web Application
                </div>
              </div>
              <div class="credit-item">
                <div class="credit-name">Eran Ben Alia</div>
                <div class="credit-role">Survey Design</div>
              </div>
              <div class="credit-item">
                <div class="credit-name">Yonatan Cohen</div>
                <div class="credit-role">Visual Design & Resources</div>
              </div>
              <div class="credit-item">
                <div class="credit-name">Merav Battat</div>
                <div class="credit-role">Leadership & Resources</div>
              </div>
            </div>
          </div>

          <!-- Comment Section -->
          <div class="comment-section">
            <div class="comment-header">
              <h3>Share Your Feedback</h3>
              <button class="comment-send-btn" onclick="submitFeedback()">
                Send Feedback
              </button>
            </div>
            <div class="comment-form">
              <textarea
                class="comment-textarea"
                placeholder="Share your experiences traveling to BGU, ideas about how to improve the streetscape, or questions about this map. Your feedback helps our research."
              ></textarea>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Chart Modal -->
    <div id="chartModal" class="chart-modal" aria-hidden="true">
      <div class="chart-modal-content">
        <div class="chart-modal-header">
          <span id="chartTitle">Chart</span>
          <button
            class="chart-modal-close"
            onclick="closeChartModal()"
            aria-label="Close chart"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>
        <iframe
          id="chartFrame"
          class="chart-frame"
          src="about:blank"
          title="Chart"
        ></iframe>
      </div>
    </div>

    <!-- Offscreen chart preloader host (keeps iframes alive) -->
    <div
      id="chartPreloadHost"
      aria-hidden="true"
      style="
        position: absolute;
        width: 1px;
        height: 1px;
        left: -99999px;
        top: -99999px;
        overflow: hidden;
        opacity: 0;
        pointer-events: none;
      "
    ></div>

    <!-- Config (Supabase URL & Key) -->
    <script src="./config.js"></script>
    <!-- Map Controller Script -->
    <script src="assets/js/map-controller.js"></script>
    <!-- Supabase JS (optional) -->
    <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>

    <script>
      // Supabase configuration (replace with real values or leave empty for fallback)
      const SUPABASE_URL = window.SUPABASE_URL || "";
      const SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || "";
      let supabaseClient = null;
      try {
        if (SUPABASE_URL && SUPABASE_ANON_KEY && window.supabase) {
          supabaseClient = supabase.createClient(
            SUPABASE_URL,
            SUPABASE_ANON_KEY
          );
        }
      } catch (e) {
        console.warn("Supabase initialization failed", e);
      }

      async function submitFeedback() {
        const textarea = document.querySelector(".comment-textarea");
        const note = (textarea?.value || "").trim();

        if (!note) {
          alert("Please enter a comment.");
          return;
        }

        if (!supabaseClient) {
          alert("Feedback service is not configured. Please try again later.");
          return;
        }

        try {
          const { error } = await supabaseClient.from("feedback").insert([
            {
              note,
              created_at: new Date().toISOString(),
            },
          ]);
          if (error) throw error;
          alert("Thanks for your feedback!");
          if (textarea) textarea.value = "";
        } catch (err) {
          console.error("Failed to save feedback:", err);
          alert(
            "Sorry, we couldn't save your feedback. Please try again later."
          );
        }
      }
      // Info modal functionality
      function toggleInfoModal() {
        const modal = document.getElementById("infoModal");
        modal.classList.toggle("show");
      }

      // Close modal when clicking outside
      document
        .getElementById("infoModal")
        .addEventListener("click", function (e) {
          if (e.target === this) {
            toggleInfoModal();
          }
        });

      // Close modal with escape key
      document.addEventListener("keydown", function (e) {
        if (e.key === "Escape") {
          const modal = document.getElementById("infoModal");
          if (modal.classList.contains("show")) {
            toggleInfoModal();
          }
        }
      });

      // Move MapLibre controls into the same container as custom controls
      function moveMapLibreControls() {
        const mapLibreControls = document.querySelector(
          ".maplibregl-ctrl-top-right"
        );
        const container = document.getElementById(
          "maplibre-controls-container"
        );

        if (mapLibreControls && container) {
          container.appendChild(mapLibreControls);
        } else {
          // Try again after a short delay if controls aren't ready yet
          setTimeout(moveMapLibreControls, 100);
        }
      }

      // Wait for the map to be initialized and controls to be created
      document.addEventListener("DOMContentLoaded", function () {
        // Give the map time to initialize
        setTimeout(moveMapLibreControls, 500);
        // Preload chart iframes offscreen for instant display
        try {
          const preloadHost = document.getElementById("chartPreloadHost");
          console.assert(!!preloadHost, "Preload host must exist");
          const links = Array.from(document.querySelectorAll("[data-chart]"));
          const uniqueUrls = Array.from(
            new Set(
              links.map((el) => el.getAttribute("data-chart")).filter(Boolean)
            )
          );
          window.__preloadedCharts = new Map();
          uniqueUrls.forEach((url) => {
            const iframe = document.createElement("iframe");
            iframe.className = "chart-frame";
            iframe.setAttribute("title", `Preloaded ${url}`);
            iframe.setAttribute("loading", "eager");
            iframe.style.width = "1px";
            iframe.style.height = "1px";
            iframe.style.border = "0";
            iframe.style.background = "#0f1214";
            iframe.dataset.chartUrl = url;
            iframe.src = url;
            preloadHost.appendChild(iframe);
            window.__preloadedCharts.set(url, { iframe, loaded: false });
            iframe.addEventListener("load", () => {
              const entry = window.__preloadedCharts.get(url);
              if (entry) entry.loaded = true;
            });
          });
          console.assert(
            window.__preloadedCharts.size >= uniqueUrls.length,
            "All charts should be registered in preloader"
          );
        } catch (err) {
          console.warn("Chart preloading failed", err);
        }
        // Chart modal handlers for analysis links
        document.querySelectorAll("[data-chart]")?.forEach((el) => {
          el.addEventListener("click", function (e) {
            e.preventDefault();
            const url = this.getAttribute("data-chart");
            if (!url) return;
            openChartModal(url, this.textContent?.trim() || "Chart");
          });
        });
      });

      function openChartModal(url, title) {
        const modal = document.getElementById("chartModal");
        const frame = document.getElementById("chartFrame");
        const chartTitle = document.getElementById("chartTitle");
        console.assert(!!modal && !!frame, "Chart modal elements must exist");
        // Try to use preloaded iframe if available
        const registry = window.__preloadedCharts;
        let usedPreloaded = false;
        if (registry && registry.has(url)) {
          const { iframe } = registry.get(url);
          try {
            // Ensure iframe will fill the modal
            iframe.style.width = "100%";
            iframe.style.height = "calc(100% - 50px)";
            iframe.style.border = "0";
            iframe.style.background = "#0f1214";
            // Hide placeholder frame and insert the preloaded one
            frame.style.display = "none";
            const container = modal.querySelector(".chart-modal-content");
            console.assert(
              !!container,
              "Chart modal content container must exist"
            );
            // If not already inside modal, append it (moving node preserves load state)
            if (iframe.parentElement !== container) {
              container.appendChild(iframe);
            }
            usedPreloaded = true;
            window.__currentChartUrl = url;
          } catch (e) {
            console.warn("Failed to attach preloaded iframe, falling back", e);
          }
        }
        if (!usedPreloaded) {
          frame.src = url;
          frame.style.display = "block";
          window.__currentChartUrl = null;
        }
        chartTitle.textContent = title;
        modal.classList.add("show");
      }

      function closeChartModal() {
        const modal = document.getElementById("chartModal");
        const frame = document.getElementById("chartFrame");
        if (!modal || !frame) return;
        try {
          const currentUrl = window.__currentChartUrl;
          const registry = window.__preloadedCharts;
          if (currentUrl && registry && registry.has(currentUrl)) {
            // Move the preloaded iframe back to the offscreen host to keep it loaded
            const entry = registry.get(currentUrl);
            const iframe = entry?.iframe;
            const preloadHost = document.getElementById("chartPreloadHost");
            if (iframe && preloadHost) {
              iframe.style.width = "1px";
              iframe.style.height = "1px";
              if (iframe.parentElement !== preloadHost) {
                preloadHost.appendChild(iframe);
              }
            }
            // Restore placeholder visibility
            frame.style.display = "block";
            // Do NOT reset iframe src to keep it alive
          } else {
            // Fallback: clear the placeholder frame only
            frame.src = "about:blank";
          }
        } catch (e) {
          console.warn("Error while closing chart modal", e);
        }
        modal.classList.remove("show");
      }

      // Close chart modal on overlay click and Escape
      document.addEventListener("click", function (e) {
        const modal = document.getElementById("chartModal");
        if (e.target === modal) {
          closeChartModal();
        }
      });
      document.addEventListener("keydown", function (e) {
        if (e.key === "Escape") {
          closeChartModal();
        }
      });

      // Populate walking stats bullet dynamically from outputs/walking_distance_stats.json
      (function () {
        try {
          fetch("outputs/walking_distance_stats.json")
            .then(function (r) {
              return r && r.ok ? r.json() : null;
            })
            .then(function (data) {
              if (!data) return;
              var maxKm =
                typeof data.max_walking_distance_km === "number"
                  ? data.max_walking_distance_km
                  : null;
              var medianKm =
                typeof data.median_walking_distance_km === "number"
                  ? data.median_walking_distance_km
                  : null;
              if (maxKm == null || medianKm == null) return;
              var maxEl = document.getElementById("walking-max");
              var medianEl = document.getElementById("walking-median");
              var bullet = document.getElementById("walking-stats-bullet");
              if (!maxEl || !medianEl || !bullet) return;
              maxEl.textContent = maxKm.toFixed(2);
              medianEl.textContent = medianKm.toFixed(2);
              bullet.style.display = "";
            })
            .catch(function () {
              /* silent */
            });
        } catch (e) {}
      })();
    </script>
  </body>
</html>
